<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Lipide Coach — Notes (1 à 20)</title>
<style>
  :root{--bg:#fff;--fg:#0f172a;--muted:#64748b;--card:#ffffff;--border:#e5e7eb;
        --ok:#16a34a;--mid:#f59e0b;--bad:#dc2626;}
  *{box-sizing:border-box} body{margin:0;background:#f7f8fb;color:var(--fg);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--border);padding:12px 14px;z-index:10}
  h1{font-size:1.1rem;margin:0} main{max-width:1000px;margin:0 auto;padding:14px}
  .grid{display:grid;gap:12px} .g-3{grid-template-columns: 2fr 1fr} .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
  label{font-weight:600;font-size:.9rem;margin-bottom:6px;display:block}
  input,select,button{font:inherit} input[type=text],input[type=number],select{width:100%;padding:9px;border:1px solid #d1d5db;border-radius:10px;background:#fff}
  button{border:none;padding:9px 12px;border-radius:10px;cursor:pointer;font-weight:600}
  .btn{background:#eaf2ff} .btn-primary{background:#0ea5e9;color:#fff}
  .btn-danger{background:#fee2e2} .row{display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end}
  table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden}
  th,td{padding:10px;border-bottom:1px solid #f1f5f9;text-align:right} th:first-child,td:first-child{text-align:left}
  .mini{font-size:.8rem;color:var(--muted)} .flex{display:flex;gap:10px;flex-wrap:wrap}
  .note{border:1px solid var(--border);border-radius:12px;padding:10px;min-width:150px;flex:1}
  .score{font-size:1.6rem;font-weight:800}
  .tag{font-size:.75rem;background:#f1f5f9;border-radius:999px;padding:2px 8px}
  .ok{color:var(--ok)} .mid{color:var(--mid)} .bad{color:var(--bad)}
  .suggest{position:relative} .suggest-list{position:absolute;left:0;right:0;top:100%;
    background:#fff;border:1px solid var(--border);border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,.08);max-height:260px;overflow:auto;z-index:20}
  .s-item{padding:8px 10px;display:flex;justify-content:space-between} .s-item:hover{background:#f8fafc}
</style>
</head>
<body>
<header><h1>Lipide Coach — repas & notes (1 à 20)</h1>
<div class="mini">Ajoute tes aliments → calcule → notes HDL, LDL, Glycémie, Triglycérides, Hypertension, Stéatose.</div></header>

<main class="grid g-3">
  <section class="card">
    <div class="row">
      <div class="suggest" style="flex:2">
        <label>Aliment / plat</label>
        <input id="food" type="text" placeholder="ex. saumon, baguette, lasagnes, salade César…" autocomplete="off">
        <div id="suggest" class="suggest-list" hidden></div>
      </div>
      <div>
        <label>Quantité</label>
        <input id="qty" type="number" min="0" step="1" value="100">
      </div>
      <div>
        <label>Unité</label>
        <select id="unit">
          <option value="g">g</option>
          <option value="portion">portion</option>
        </select>
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="add" class="btn-primary">Ajouter</button>
      </div>
    </div>

    <table id="meal" style="margin-top:10px">
      <thead><tr>
        <th>Aliment</th><th>Qté (g)</th><th>Lipides</th><th>Sat.</th><th>Gluc.</th><th>Prot.</th><th>Kcal</th><th></th>
      </tr></thead>
      <tbody></tbody>
      <tfoot><tr>
        <td>Totaux</td><td id="t_q">0</td><td id="t_f">0</td><td id="t_s">0</td><td id="t_c">0</td><td id="t_p">0</td><td id="t_k">0</td><td></td>
      </tr></tfoot>
    </table>

    <div class="row" style="margin-top:8px">
      <button id="save" class="btn">Sauver</button>
      <button id="load" class="btn">Charger</button>
      <button id="clear" class="btn-danger">Vider</button>
      <button id="export" class="btn">Exporter CSV</button>
      <label class="mini">Base élargie intégrée (modifiable via import CSV dans une prochaine étape si tu veux).</label>
    </div>
  </section>

  <aside class="card">
    <div class="flex">
      <div class="note"><div class="mini">HDL</div><div id="n_hdl" class="score">—</div><div id="c_hdl" class="mini"></div></div>
      <div class="note"><div class="mini">LDL</div><div id="n_ldl" class="score">—</div><div id="c_ldl" class="mini"></div></div>
    </div>
    <div class="flex" style="margin-top:8px">
      <div class="note"><div class="mini">Glycémie</div><div id="n_gly" class="score">—</div><div id="c_gly" class="mini"></div></div>
      <div class="note"><div class="mini">Triglycérides</div><div id="n_tri" class="score">—</div><div id="c_tri" class="mini"></div></div>
    </div>
    <div class="flex" style="margin-top:8px">
      <div class="note"><div class="mini">Hypertension</div><div id="n_ht" class="score">—</div><div id="c_ht" class="mini"></div></div>
      <div class="note"><div class="mini">Stéatose hépatique</div><div id="n_fat" class="score">—</div><div id="c_fat" class="mini"></div></div>
    </div>
  </aside>
</main>

<script>
// ===== Base élargie (100 g, sauf "portion_g") =====
const DB = [
  // Huiles & beurres
  {nom:"Huile d'olive", lipides:100, sat:14, glucides:0, proteines:0, kcal:900, omega3:0.8, sel:0, portion_g:10},
  {nom:"Huile de colza", lipides:100, sat:7, glucides:0, proteines:0, kcal:900, omega3:9, sel:0, portion_g:10},
  {nom:"Beurre", lipides:82, sat:51, glucides:1, proteines:0.6, kcal:744, omega3:0, sel:0.02, portion_g:10},

  // Oléagineux
  {nom:"Noix", lipides:65, sat:6, glucides:7, proteines:15, kcal:654, omega3:9, sel:0, portion_g:30},
  {nom:"Amande", lipides:50, sat:4, glucides:9, proteines:21, kcal:579, omega3:0, sel:0, portion_g:30},
  {nom:"Noisette", lipides:61, sat:4.5, glucides:7, proteines:15, kcal:628, omega3:0.1, sel:0, portion_g:30},

  // Poissons
  {nom:"Saumon (cuit)", lipides:13, sat:3, glucides:0, proteines:25, kcal:208, omega3:2.5, sel:0.1, portion_g:120},
  {nom:"Maquereau (cuit)", lipides:17, sat:4, glucides:0, proteines:24, kcal:262, omega3:3, sel:0.1, portion_g:120},
  {nom:"Thon au naturel", lipides:1, sat:0.3, glucides:0, proteines:24, kcal:109, omega3:0.2, sel:0.4, portion_g:100},

  // Viandes / œufs
  {nom:"Poulet (blanc, cuit)", lipides:3.6, sat:1, glucides:0, proteines:31, kcal:165, omega3:0.05, sel:0.1, portion_g:120},
  {nom:"Bœuf steak 5% (cuit)", lipides:6, sat:2.5, glucides:0, proteines:27, kcal:170, omega3:0.05, sel:0.1, portion_g:120},
  {nom:"Œuf", lipides:10.6, sat:3.3, glucides:1.1, proteines:12.6, kcal:143, omega3:0.1, sel:0.12, portion_g:60},

  // Laitiers / salés
  {nom:"Emmental", lipides:28, sat:18, glucides:0, proteines:27, kcal:380, omega3:0, sel:0.8, portion_g:30},
  {nom:"Camembert", lipides:21, sat:14, glucides:0.5, proteines:20, kcal:290, omega3:0, sel:1.4, portion_g:30},
  {nom:"Jambon sec", lipides:15, sat:5, glucides:1, proteines:30, kcal:250, omega3:0, sel:4.5, portion_g:40},

  // Céréales / pains
  {nom:"Pain baguette", lipides:1, sat:0.2, glucides:56, proteines:8, kcal:270, omega3:0, sel:1.5, portion_g:60},
  {nom:"Pâtes cuites", lipides:1.1, sat:0.2, glucides:25, proteines:4.7, kcal:131, omega3:0, sel:0.02, portion_g:180},
  {nom:"Riz blanc cuit", lipides:0.4, sat:0.1, glucides:28, proteines:2.7, kcal:130, omega3:0, sel:0.01, portion_g:150},

  // Légumineuses / fibres
  {nom:"Lentilles cuites", lipides:0.4, sat:0.1, glucides:20, proteines:9, kcal:116, omega3:0.1, sel:0.02, portion_g:180},
  {nom:"Pois chiches cuits", lipides:3, sat:0.3, glucides:27, proteines:9, kcal:164, omega3:0.1, sel:0.02, portion_g:150},

  // Plats (approximations pratiques)
  {nom:"Lasagnes bolognaise", lipides:9, sat:4, glucides:16, proteines:8, kcal:190, omega3:0.05, sel:1.1, portion_g:250},
  {nom:"Gratin dauphinois", lipides:10, sat:6, glucides:13, proteines:3, kcal:165, omega3:0, sel:0.9, portion_g:200},
  {nom:"Pizza margherita", lipides:9, sat:4, glucides:28, proteines:10, kcal:240, omega3:0, sel:1.4, portion_g:120},
  {nom:"Burger classique", lipides:13, sat:5, glucides:25, proteines:15, kcal:270, omega3:0, sel:1.5, portion_g:180},
  {nom:"Kebab sandwich", lipides:12, sat:4, glucides:23, proteines:16, kcal:250, omega3:0, sel:1.9, portion_g:250},
  {nom:"Salade César", lipides:14, sat:4, glucides:6, proteines:10, kcal:190, omega3:0, sel:1.4, portion_g:200},
  {nom:"Tartiflette", lipides:16, sat:9, glucides:13, proteines:10, kcal:240, omega3:0, sel:1.6, portion_g:250},
  {nom:"Chili con carne", lipides:6, sat:2, glucides:12, proteines:10, kcal:150, omega3:0, sel:1.1, portion_g:250},
  {nom:"Sushi assortiment", lipides:4, sat:1, glucides:28, proteines:11, kcal:190, omega3:0.3, sel:1.3, portion_g:180},
  {nom:"Frites (four)", lipides:8, sat:1.2, glucides:33, proteines:3.4, kcal:230, omega3:0, sel:0.7, portion_g:150},
];

// --- utilitaires ---
const $ = s=>document.querySelector(s);
const fmt = n => (Math.round(n*10)/10).toLocaleString('fr-FR');
const suggest = $('#suggest'), foodI = $('#food');

let INDEX = DB.map((x,i)=>({k:x.nom.toLowerCase(),i}));

foodI.addEventListener('input', ()=>{
  const q = foodI.value.trim().toLowerCase();
  if(!q){suggest.hidden=true; return;}
  const hits = INDEX.filter(o=>o.k.includes(q)).slice(0,20).map(o=>DB[o.i]);
  suggest.innerHTML = hits.map(x=>`<div class="s-item"><span>${x.nom}</span>
    <span class="mini">${x.kcal} kcal • ${x.lipides}g lip. • ${x.sel??0}g sel</span></div>`).join('');
  [...suggest.children].forEach((el,idx)=> el.onclick = ()=>{ foodI.value = hits[idx].nom; suggest.hidden=true; });
  suggest.hidden = hits.length===0;
});
foodI.addEventListener('focus', ()=>foodI.dispatchEvent(new Event('input')));

const tbody = document.querySelector('#meal tbody');

$('#add').onclick = ()=>{
  const name = foodI.value.trim();
  const qty = parseFloat($('#qty').value||'0');
  const unit = $('#unit').value;
  if(!name||!qty) return;
  const rec = DB.find(x=>x.nom.toLowerCase()===name.toLowerCase());
  if(!rec){ alert("Aliment non trouvé."); return; }
  const grams = unit==='g' ? qty : (rec.portion_g||100)*qty;
  const f = grams/100;

  const tr = document.createElement('tr');
  tr.innerHTML = `<td>${rec.nom}</td>
    <td>${fmt(grams)}</td>
    <td>${fmt(rec.lipides*f)}</td>
    <td>${fmt(rec.sat*f)}</td>
    <td>${fmt(rec.glucides*f||0)}</td>
    <td>${fmt(rec.proteines*f||0)}</td>
    <td>${fmt(rec.kcal*f||0)}</td>
    <td><button class="btn-danger">X</button></td>`;
  tr.querySelector('button').onclick = ()=>{ tr.remove(); totals(); };
  tbody.appendChild(tr);
  foodI.value=''; suggest.hidden=true; totals();
};

$('#clear').onclick = ()=>{ tbody.innerHTML=''; totals(); };
$('#save').onclick = ()=>{
  const rows = [...tbody.rows].map(r=>({nom:r.cells[0].textContent, g:num(r.cells[1].textContent)}));
  localStorage.setItem('lc_meal', JSON.stringify(rows));
};
$('#load').onclick = ()=>{
  const raw = localStorage.getItem('lc_meal'); if(!raw) return;
  tbody.innerHTML='';
  JSON.parse(raw).forEach(({nom,g})=>{
    const rec = DB.find(x=>x.nom===nom); if(!rec) return;
    const f = g/100;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${rec.nom}</td>
      <td>${fmt(g)}</td>
      <td>${fmt(rec.lipides*f)}</td>
      <td>${fmt(rec.sat*f)}</td>
      <td>${fmt(rec.glucides*f||0)}</td>
      <td>${fmt(rec.proteines*f||0)}</td>
      <td>${fmt(rec.kcal*f||0)}</td>
      <td><button class="btn-danger">X</button></td>`;
    tr.querySelector('button').onclick = ()=>{ tr.remove(); totals(); };
    tbody.appendChild(tr);
  });
  totals();
};
$('#export').onclick = ()=>{
  const head = 'aliment,grammes,lipides,satures,glucides,proteines,kcal';
  const lines = [...tbody.rows].map(r=>[
    r.cells[0].textContent, ...[1,2,3,4,5,6].map(i=>num(r.cells[i].textContent))
  ].join(','));
  download('repas.csv',[head,...lines].join('\n'));
};
function download(name, content){
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([content],{type:'text/plain'}));
  a.download = name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500);
}
function num(s){return parseFloat(String(s).replace(/\s/g,'').replace(',','.'))||0}

function totals(){
  let g=0,f=0,s=0,c=0,p=0,k=0, om3=0, salt=0;
  [...tbody.rows].forEach(r=>{
    g += num(r.cells[1].textContent);
    f += num(r.cells[2].textContent);
    s += num(r.cells[3].textContent);
    c += num(r.cells[4].textContent);
    p += num(r.cells[5].textContent);
    k += num(r.cells[6].textContent);
    // retrouver fiche
    const rec = DB.find(x=>x.nom===r.cells[0].textContent);
    const factor = num(r.cells[1].textContent)/100;
    om3 += (rec.omega3||0)*factor;
    salt += (rec.sel||0)*factor;
  });
  $('#t_q').textContent=fmt(g); $('#t_f').textContent=fmt(f); $('#t_s').textContent=fmt(s);
  $('#t_c').textContent=fmt(c); $('#t_p').textContent=fmt(p); $('#t_k').textContent=fmt(k);
  scoreAll({g,f,s,c,p,k,om3:safe(om3),salt:safe(salt)});
}
const clamp=(x,a,b)=>Math.min(Math.max(x,a),b);
const safe=x=>Math.round(x*100)/100;

function scoreAll(t){
  // densités par 1000 kcal (plus parlant pour le barème)
  const densFat = t.k? (t.f*900)/t.k : 0;           // énergie des lipides / kcal totales
  const satPer1000 = t.k ? (t.s*1000)/t.k : 0;      // g saturés / 1000 kcal
  const carbPer1000= t.k ? (t.c*1000)/t.k : 0;      // g glucides / 1000 kcal

  // HDL: bonus Ω3 + petits bonus noix/poisson gras
  let HDL = 10;
  if(t.om3>=1.5) HDL += 4;
  if(t.om3>=2.5) HDL += 2;         // jusqu’à +6
  HDL = clamp(Math.round(HDL),1,20);

  // LDL: pénalise saturés/1000kcal (3→25 g/1000 kcal)
  const ldlPen = scale(satPer1000, 3, 25, 0, 14);   // max −14
  let LDL = 20 - ldlPen; LDL = clamp(Math.round(LDL),1,20);

  // Glycémie: pénalise charge glucidique/1000kcal (80→220)
  const glyPen = scale(carbPer1000, 80, 220, 0, 14);
  let GLY = 20 - glyPen; GLY = clamp(Math.round(GLY),1,20);

  // Triglycérides: mix excès glucides + kcal denses, bonus Ω3
  let TRI = 20 - Math.round( (scale(carbPer1000,100,220,0,10)) + (scale(t.k/(t.g||1), 1.5, 3.5, 0, 6)) );
  TRI += (t.om3>=1.5?2:0);
  TRI = clamp(TRI,1,20);

  // Hypertension: pénalise sodium (0.5→3 g sel par repas), + pénalité charcut/fromage/pains salés détectés
  let sodium = t.salt; // g de sel estimé
  let HT = 20 - Math.round(scale(sodium, 0.5, 3, 0, 14));
  // heuristique: si fromage/charcuterie/pizza/kebab dans la liste, petit -1 chacun
  const names = [...tbody.rows].map(r=>r.cells[0].textContent.toLowerCase()).join(' ');
  const hits = ["emmental","camembert","jambon","pizza","kebab","burger","pain"].filter(k=>names.includes(k)).length;
  HT -= Math.min(hits,3);
  HT = clamp(HT,1,20);

  // Stéatose: pénalise densité calorique + saturés
  let FATL = 20 - Math.round( scale(t.k/(t.g||1), 1.5, 3.5, 0, 10) + scale(satPer1000, 5, 20, 0, 6) );
  FATL = clamp(FATL,1,20);

  setNote('#n_hdl', HDL, '#c_hdl', commentHDL(HDL,t));
  setNote('#n_ldl', LDL, '#c_ldl', commentLDL(LDL,t,satPer1000));
  setNote('#n_gly', GLY, '#c_gly', commentGLY(GLY,t,carbPer1000));
  setNote('#n_tri', TRI, '#c_tri', commentTRI(TRI,t,carbPer1000));
  setNote('#n_ht',  HT,  '#c_ht',  commentHT(HT,t));
  setNote('#n_fat', FATL,'#c_fat', commentFATL(FATL,t));
}
function scale(x, a, b, A, B){
  if (x<=a) return A; if (x>=b) return B;
  const r=(x-a)/(b-a); return A + r*(B-A);
}
function setNote(idScore, val, idCom, txt){
  const el = document.querySelector(idScore);
  el.textContent = val;
  el.classList.remove('ok','mid','bad');
  el.classList.add(val>=15?'ok':val>=10?'mid':'bad');
  document.querySelector(idCom).textContent = txt;
}
function commentHDL(n,t){
  if(t.om3>=2.5) return "Ω3 élevés (poisson gras/noix) → bon coup de pouce HDL.";
  if(t.om3>=1.5) return "Un peu d’Ω3 présents, c’est positif.";
  return "Peu d’Ω3 détectés. Poisson gras/noix/colza aident.";
}
function commentLDL(n,t,sat1000){
  if(n>=15) return "Saturés raisonnables.";
  if(n>=10) return `Saturés un peu hauts (~${sat1000.toFixed(0)} g/1000 kcal).`;
  return `Saturés élevés (~${sat1000.toFixed(0)} g/1000 kcal). Limiter beurre/fromages/charcuteries.`;
}
function commentGLY(n,t,carb1000){
  if(n>=15) return "Charge glucidique modérée.";
  if(n>=10) return `Glu. un peu hauts (~${carb1000.toFixed(0)} g/1000 kcal).`;
  return `Charge glucidique élevée (~${carb1000.toFixed(0)} g/1000 kcal). Réduire pain/pâtes/desserts.`;
}
function commentTRI(n,t,carb1000){
  if(n>=15) return "Equilibre correct pour les triglycérides.";
  if(n>=10) return `Attention aux glucides rapides (~${carb1000.toFixed(0)} g/1000 kcal).`;
  return "Excès glucides/kcal. Bonus possible: poisson gras, limiter boissons sucrées.";
}
function commentHT(n,t){
  if(n>=15) return "Sodium modéré.";
  if(n>=10) return `Sel un peu élevé (~${t.salt.toFixed(2)} g).`;
  return `Sel élevé (~${t.salt.toFixed(2)} g). Réduire charcuterie/fromages/pains/plats salés.`;
}
function commentFATL(n,t){
  const dens = (t.k/(t.g||1)).toFixed(1);
  if(n>=15) return `Densité raisonnable (~${dens} kcal/100 g).`;
  if(n>=10) return `Assez dense (~${dens} kcal/100 g) et/ou saturés notables.`;
  return `Repas très dense (~${dens} kcal/100 g) et saturés à surveiller.`;
}

// initial
totals();
</script>
</body>
</html>
