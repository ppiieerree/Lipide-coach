<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lipide Coach — global (base élargie + notes)</title>
<style>
  :root{
    --fg:#111;--bg:#fff;--muted:#6b7280;--primary:#0ea5e9;
    --card:#ffffff;--border:#e5e7eb;--soft:#f7f8fa;
    --ok:#16a34a;--mid:#f59e0b;--bad:#dc2626;
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial,sans-serif;margin:0;color:var(--fg);background:var(--soft)}
  header{position:sticky;top:0;z-index:10;background:var(--card);border-bottom:1px solid var(--border);padding:14px 16px}
  h1{font-size:1.15rem;margin:0}
  main{max-width:1100px;margin:0 auto;padding:16px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px}
  label{display:block;font-weight:600;font-size:.9rem;margin-bottom:6px}
  input,select,button{font:inherit}
  input[type=text],input[type=number],select{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:10px;background:#fff}
  button{border:none;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
  .btn-primary{background:var(--primary);color:#fff}
  .btn-soft{background:#eef6ff}
  .btn-danger{background:#fee2e2}
  .grid{display:grid;gap:12px}
  .grid-3{grid-template-columns:repeat(3,1fr)}
  .full{grid-column:1/-1}
  table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden}
  th,td{padding:10px;border-bottom:1px solid #f0f2f5;text-align:right}
  th:first-child,td:first-child{text-align:left}
  tfoot td{font-weight:700;background:#fafafa}
  .muted{color:var(--muted)} .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:#f1f5f9;font-size:.75rem}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;background:#f3f4f6;padding:2px 6px;border-radius:6px}
  .suggest{position:relative}
  .suggest-list{position:absolute;left:0;right:0;top:100%;background:#fff;border:1px solid var(--border);border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.08);z-index:20;max-height:280px;overflow:auto}
  .suggest-item{padding:8px 10px;display:flex;justify-content:space-between;gap:8px}
  .suggest-item:hover{background:#f8fafc}
  .nowrap{white-space:nowrap} .badge{font-size:.7rem;padding:2px 6px;border-radius:8px;background:#eff6ff}
  .totals{display:flex;gap:10px;flex-wrap:wrap} .totals .pill{background:#eef2ff}
  .score{font-weight:800} .ok{color:var(--ok)} .mid{color:var(--mid)} .bad{color:var(--bad)}
</style>
</head>
<body>
<header>
  <h1>Lipide Coach <span class="pill">base élargie + notes 1–20</span></h1>
  <div class="muted">Saisie multiple séparée par virgules. Ex : <span class="kbd">omelette, champignons, pain baguette</span>. Les notes s’appliquent par aliment ajouté.</div>
</header>

<main class="grid">
  <section class="card grid grid-3 full">
    <div class="suggest">
      <label for="food">Aliment / plat (un ou plusieurs, séparés par des virgules)</label>
      <input id="food" type="text" placeholder="ex. omelette, saumon, lasagnes, kebab…" autocomplete="off" />
      <div id="suggestions" class="suggest-list" hidden></div>
    </div>
    <div>
      <label for="qty">Quantité</label>
      <input id="qty" type="number" step="1" min="0" value="100" />
    </div>
    <div>
      <label for="unit">Unité</label>
      <select id="unit">
        <option value="g">g</option>
        <option value="portion">portion</option>
      </select>
    </div>
    <div class="full" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <button id="add" class="btn-primary">Ajouter</button>
      <button id="save" class="btn-soft">Sauver (local)</button>
      <button id="load" class="btn-soft">Charger</button>
      <button id="clear" class="btn-danger">Vider</button>
      <button id="export-csv" class="btn-soft">Exporter CSV</button>
      <span class="muted">La quantité s’applique à **chaque** terme saisi.</span>
    </div>
  </section>

  <section class="full">
    <table id="meal">
      <thead>
        <tr>
          <th>Aliment</th>
          <th class="nowrap">Qté (g)</th>
          <th>Lipides (g)</th>
          <th>Sat. (g)</th>
          <th>Gluc. (g)</th>
          <th>Prot. (g)</th>
          <th>Kcal</th>
          <th>HDL</th>
          <th>LDL</th>
          <th>Gly</th>
          <th>Tri</th>
          <th>HTA</th>
          <th>Stéat.</th>
          <th></th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <td>Totaux</td>
          <td id="t_qte">0</td>
          <td id="t_lip">0</td>
          <td id="t_sat">0</td>
          <td id="t_glu">0</td>
          <td id="t_pro">0</td>
          <td id="t_kcal">0</td>
          <td colspan="7"></td>
        </tr>
      </tfoot>
    </table>
    <div class="totals" style="margin-top:10px">
      <span class="pill"><strong>Ratio lipides/kcal</strong> : <span id="ratio">0%</span></span>
      <span class="pill"><strong>AG saturés</strong> : <span id="satShare">0%</span> des lipides</span>
    </div>
    <p class="muted">Notes heuristiques (1–20) — bonus **Ω3** pour HDL, malus **sel** pour HTA. Indications pédagogiques, pas médicales.</p>
  </section>
</main>

<script>
// ===== Normalisation & fuzzy =====
const norm = s => String(s).toLowerCase()
  .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
  .replace(/[^a-z0-9 ]/g,' ').replace(/\s+/g,' ').trim();
function lev(a,b){
  a=norm(a); b=norm(b);
  const m=a.length, n=b.length;
  const dp = Array(n+1).fill(0).map((_,i)=>i);
  for(let i=1;i<=m;i++){
    let prev=i-1, cur=i;
    for(let j=1;j<=n;j++){
      const tmp = dp[j];
      dp[j] = Math.min(dp[j]+1, cur+1, prev + (a[i-1]===b[j-1]?0:1));
      prev = tmp; cur = dp[j];
    }
  }
  return dp[n];
}

// ===== Base TRÈS élargie avec alias (extraits principaux + nombreux plats) =====
// Champs obligatoires: nom, lipides, sat, glucides, proteines, kcal
// Optionnels: portion_g (g), omega3 (g/100g), sel (g/100g), alias:[...]
const DB = [
  // --- Matières grasses
  {nom:"Huile d'olive", alias:["huile olive","olive"], lipides:100, sat:14, glucides:0, proteines:0, kcal:900, portion_g:10, omega3:0.8, sel:0},
  {nom:"Huile de colza", alias:["huile colza","colza","canola"], lipides:100, sat:7, glucides:0, proteines:0, kcal:900, portion_g:10, omega3:9, sel:0},
  {nom:"Beurre doux", alias:["beurre"], lipides:82, sat:51, glucides:1, proteines:0.6, kcal:744, portion_g:10, sel:0.02},
  {nom:"Margarine", alias:["margarine vegetale"], lipides:80, sat:20, glucides:1, proteines:0, kcal:720, portion_g:10},

  // --- Fruits oléagineux
  {nom:"Amande", alias:["amandes"], lipides:50, sat:4, glucides:9, proteines:21, kcal:579, portion_g:30},
  {nom:"Noisette", alias:["noisettes"], lipides:61, sat:4.5, glucides:7, proteines:15, kcal:628, portion_g:30},
  {nom:"Noix", alias:["cerneaux de noix"], lipides:65, sat:6, glucides:7, proteines:15, kcal:654, portion_g:30, omega3:9},
  {nom:"Pistache", alias:["pistaches"], lipides:46, sat:6, glucides:28, proteines:20, kcal:562, portion_g:30},
  {nom:"Cacahuète", alias:["arachide","cacahuetes"], lipides:49, sat:7, glucides:16, proteines:26, kcal:567, portion_g:30},

  // --- Fruits & légumes
  {nom:"Avocat", alias:["avocats"], lipides:15, sat:2.1, glucides:9, proteines:2, kcal:160, portion_g:100},
  {nom:"Tomate", alias:["tomates"], lipides:0.2, sat:0, glucides:3.5, proteines:0.8, kcal:18, portion_g:120},
  {nom:"Champignon de Paris (cuit)", alias:["champignons","champignon"], lipides:0.3, sat:0.1, glucides:3.3, proteines:3.1, kcal:22, portion_g:120, sel:0.01},
  {nom:"Pomme de terre (cuite)", alias:["pdt","patate cuite"], lipides:0.1, sat:0, glucides:17, proteines:2, kcal:87, portion_g:150},
  {nom:"Brocoli", alias:["brocolis"], lipides:0.4, sat:0.1, glucides:7, proteines:2.8, kcal:34, portion_g:90},
  {nom:"Carotte", alias:["carottes"], lipides:0.2, sat:0, glucides:7, proteines:0.9, kcal:41, portion_g:80},
  {nom:"Courgette", alias:["courgettes"], lipides:0.4, sat:0.1, glucides:3.1, proteines:1.2, kcal:17, portion_g:120},
  {nom:"Pomme", alias:["pommes"], lipides:0.3, sat:0.05, glucides:12, proteines:0.3, kcal:52, portion_g:150},
  {nom:"Banane", alias:["bananes"], lipides:0.3, sat:0.1, glucides:20, proteines:1.1, kcal:96, portion_g:120},

  // --- Céréales, pains & féculents
  {nom:"Riz blanc cuit", alias:["riz cuit"], lipides:0.4, sat:0.1, glucides:28, proteines:2.7, kcal:130, portion_g:150},
  {nom:"Riz basmati cuit", alias:["basmati"], lipides:0.4, sat:0.1, glucides:27, proteines:2.9, kcal:125, portion_g:150},
  {nom:"Pâtes cuites", alias:["pates cuites","pâtes"], lipides:1.1, sat:0.2, glucides:25, proteines:4.7, kcal:131, portion_g:180},
  {nom:"Quinoa cuit", alias:["quinoa"], lipides:1.9, sat:0.2, glucides:21, proteines:4.4, kcal:120, portion_g:150},
  {nom:"Boulgour cuit", alias:["boulghour"], lipides:0.2, sat:0, glucides:18, proteines:3.1, kcal:83, portion_g:150},
  {nom:"Pain baguette", alias:["baguette","pain blanc"], lipides:1, sat:0.2, glucides:56, proteines:8, kcal:270, portion_g:60, sel:1.5},
  {nom:"Pain complet", alias:["pain integral","pain complet"], lipides:3, sat:0.5, glucides:41, proteines:9, kcal:247, portion_g:50, sel:1.2},
  {nom:"Flocons d'avoine", alias:["avoine","porridge"], lipides:7, sat:1.2, glucides:60, proteines:13, kcal:379, portion_g:40},

  // --- Produits laitiers & fromages
  {nom:"Lait demi-écrémé", alias:["lait 1/2 ecreme"], lipides:1.6, sat:1, glucides:5, proteines:3.4, kcal:47, portion_g:200, sel:0.1},
  {nom:"Yaourt nature", alias:["yaourt"], lipides:3.3, sat:2.1, glucides:4.7, proteines:4, kcal:61, portion_g:125, sel:0.1},
  {nom:"Fromage blanc 20%", alias:["fromage blanc"], lipides:3, sat:2, glucides:3.9, proteines:8.5, kcal:80, portion_g:100, sel:0.1},
  {nom:"Emmental", alias:["gruyere","emmenthal"], lipides:28, sat:18, glucides:0, proteines:27, kcal:380, portion_g:30, sel:0.8},
  {nom:"Camembert", alias:["camembert de normandie"], lipides:21, sat:14, glucides:0.5, proteines:20, kcal:290, portion_g:30, sel:1.4},
  {nom:"Mozzarella", alias:["mozza"], lipides:17, sat:11, glucides:3, proteines:22, kcal:280, portion_g:30, sel:0.6},
  {nom:"Parmesan", alias:["parmigiano"], lipides:28, sat:18, glucides:4, proteines:33, kcal:392, portion_g:20, sel:1.6},

  // --- Viandes, œufs, charcuteries
  {nom:"Œuf", alias:["oeuf","œufs","oeufs"], lipides:10.6, sat:3.3, glucides:1.1, proteines:12.6, kcal:143, portion_g:60, omega3:0.1, sel:0.12},
  {nom:"Omelette nature", alias:["omelette","omelette aux oeufs","omelette aux œufs"], lipides:15, sat:5.5, glucides:1.6, proteines:13, kcal:200, portion_g:120, sel:0.9},
  {nom:"Œufs brouillés", alias:["oeufs brouilles","scrambled eggs"], lipides:14, sat:5, glucides:2, proteines:11, kcal:190, portion_g:120, sel:0.9},
  {nom:"Omelette jambon-fromage", alias:["omelette fromage","omelette jambon"], lipides:20, sat:9, glucides:2, proteines:18, kcal:260, portion_g:180, sel:1.9},
  {nom:"Poulet (blanc, cuit)", alias:["poulet","blanc de poulet"], lipides:3.6, sat:1, glucides:0, proteines:31, kcal:165, portion_g:120, sel:0.1},
  {nom:"Bœuf steak 5% MG (cuit)", alias:["steak 5%","boeuf 5%"], lipides:6, sat:2.5, glucides:0, proteines:27, kcal:170, portion_g:120, sel:0.1},
  {nom:"Viande hachée 15% (cuit)", alias:["steak haché 15%"], lipides:15, sat:6, glucides:0, proteines:26, kcal:250, portion_g:120, sel:0.1},
  {nom:"Porc échine (cuit)", alias:["porc"], lipides:20, sat:7.5, glucides:0, proteines:26, kcal:280, portion_g:120, sel:0.1},
  {nom:"Jambon blanc", alias:["jambon cuit","jambon"], lipides:3, sat:1, glucides:1, proteines:20, kcal:116, portion_g:50, sel:2.1},
  {nom:"Jambon cru", alias:["jambon sec","parme","bayonne"], lipides:15, sat:5, glucides:1, proteines:30, kcal:250, portion_g:40, sel:4.5},
  {nom:"Saucisson sec", alias:["saucisson"], lipides:35, sat:13, glucides:1, proteines:23, kcal:420, portion_g:30, sel:4.2},

  // --- Poissons & mer
  {nom:"Saumon (cuit)", alias:["saumon"], lipides:13, sat:3, glucides:0, proteines:25, kcal:208, portion_g:120, omega3:2.5, sel:0.1},
  {nom:"Maquereau (cuit)", alias:["maquereau"], lipides:17, sat:4, glucides:0, proteines:24, kcal:262, portion_g:120, omega3:3, sel:0.1},
  {nom:"Sardines à l'huile (égouttées)", alias:["sardines"], lipides:11, sat:2.5, glucides:0, proteines:25, kcal:208, portion_g:100, omega3:2, sel:0.9},
  {nom:"Cabillaud (cuit)", alias:["cabillaud","morue fraiche"], lipides:0.7, sat:0.1, glucides:0, proteines:24, kcal:105, portion_g:120, sel:0.2},
  {nom:"Thon au naturel (égoutté)", alias:["thon boite","thon naturel"], lipides:1, sat:0.3, glucides:0, proteines:24, kcal:109, portion_g:100, omega3:0.2, sel:0.4},

  // --- Légumineuses & soja
  {nom:"Lentilles cuites", alias:["lentilles"], lipides:0.4, sat:0.1, glucides:20, proteines:9, kcal:116, portion_g:180, sel:0.02},
  {nom:"Pois chiches cuits", alias:["pois chiches"], lipides:3, sat:0.3, glucides:27, proteines:9, kcal:164, portion_g:150, sel:0.02},
  {nom:"Haricots rouges cuits", alias:["haricots rouges"], lipides:0.5, sat:0.1, glucides:22, proteines:8.7, kcal:127, portion_g:150, sel:0.02},
  {nom:"Tofu nature", alias:["tofu"], lipides:4, sat:0.7, glucides:1.9, proteines:12, kcal:76, portion_g:100, sel:0.02},
  {nom:"Falafel (3 pièces)", alias:["falafels"], lipides:11, sat:1.5, glucides:18, proteines:7, kcal:220, portion_g:90, sel:0.8},
  {nom:"Hummus", alias:["houmous","hummus"], lipides:19, sat:2.3, glucides:14, proteines:8, kcal:290, portion_g:30, sel:1.0},

  // --- Salades, soupes, légumes cuisinés
  {nom:"Ratatouille maison", alias:["ratatouille"], lipides:4, sat:0.6, glucides:7, proteines:2, kcal:80, portion_g:200, sel:0.4},
  {nom:"Salade verte (assaisonnée légère)", alias:["salade"], lipides:3, sat:0.5, glucides:2, proteines:1, kcal:40, portion_g:120, sel:0.4},
  {nom:"Salade niçoise", alias:["nicoise"], lipides:9, sat:1.8, glucides:6, proteines:10, kcal:150, portion_g:250, sel:1.3},
  {nom:"Salade César (classique)", alias:["salade cesar","cesar"], lipides:14, sat:4, glucides:6, proteines:10, kcal:190, portion_g:200, sel:1.4},
  {nom:"Soupe de légumes (maison)", alias:["soupe legumes"], lipides:1.5, sat:0.3, glucides:6, proteines:2, kcal:45, portion_g:300, sel:0.9},
  {nom:"Velouté de potiron", alias:["soupe potiron"], lipides:2, sat:0.8, glucides:8, proteines:1.5, kcal:60, portion_g:300, sel:0.9},

  // --- Plats français / monde (approximations réalistes)
  {nom:"Lasagnes bolognaise (maison)", alias:["lasagnes","lasagna"], lipides:9, sat:4, glucides:16, proteines:8, kcal:190, portion_g:250, sel:1.1},
  {nom:"Gratin dauphinois", alias:["gratin de pommes de terre"], lipides:10, sat:6, glucides:13, proteines:3, kcal:165, portion_g:200, sel:0.9},
  {nom:"Quiche lorraine", alias:["quiche"], lipides:17, sat:8, glucides:19, proteines:10, kcal:270, portion_g:130, sel:1.3},
  {nom:"Bœuf bourguignon", alias:["boeuf bourguignon"], lipides:8, sat:3, glucides:3, proteines:12, kcal:140, portion_g:250, sel:0.9},
  {nom:"Blanquette de veau", alias:["blanquette"], lipides:9, sat:4, glucides:4, proteines:12, kcal:165, portion_g:250, sel:1.0},
  {nom:"Daube de bœuf", alias:["daube"], lipides:10, sat:4, glucides:4, proteines:12, kcal:170, portion_g:250, sel:1.1},
  {nom:"Axoa de veau", alias:["axoa"], lipides:12, sat:4.5, glucides:5, proteines:14, kcal:190, portion_g:250, sel:1.3},
  {nom:"Saucisse-lentilles", alias:["saucisse lentilles"], lipides:12, sat:4.5, glucides:14, proteines:14, kcal:210, portion_g:300, sel:2.3},
  {nom:"Brandade de morue", alias:["brandade"], lipides:14, sat:3.5, glucides:12, proteines:13, kcal:210, portion_g:220, sel:1.5},
  {nom:"Bœuf carottes", alias:["boeuf carottes"], lipides:6, sat:2.2, glucides:6, proteines:12, kcal:140, portion_g:280, sel:1.0},
  {nom:"Cassoulet", alias:["cassoulet"], lipides:11, sat:4, glucides:14, proteines:11, kcal:170, portion_g:300, sel:1.8},
  {nom:"Choucroute garnie", alias:["choucroute"], lipides:12, sat:4.5, glucides:6, proteines:13, kcal:170, portion_g:350, sel:2.5},
  {nom:"Tajine poulet-abricots", alias:["tajine poulet"], lipides:7, sat:1.5, glucides:15, proteines:9, kcal:160, portion_g:250, sel:0.9},
  {nom:"Couscous poulet-légumes", alias:["couscous"], lipides:6, sat:1.5, glucides:20, proteines:8, kcal:170, portion_g:250, sel:1.1},
  {nom:"Paella mixte", alias:["paella"], lipides:7, sat:1.6, glucides:22, proteines:9, kcal:190, portion_g:250, sel:1.2},
  {nom:"Chili con carne", alias:["chili"], lipides:6, sat:2, glucides:12, proteines:10, kcal:150, portion_g:250, sel:1.1},
  {nom:"Tartiflette", alias:["tartif"], lipides:16, sat:9, glucides:13, proteines:10, kcal:240, portion_g:250, sel:1.6},
  {nom:"Raclette (assiette moyenne)", alias:["raclette"], lipides:22, sat:12, glucides:5, proteines:20, kcal:320, portion_g:300, sel:3.5},
  {nom:"Fondue savoyarde", alias:["fondue"], lipides:24, sat:14, glucides:2, proteines:22, kcal:340, portion_g:250, sel:3.0},
  {nom:"Galette complète", alias:["galette œuf jambon fromage","galette complete"], lipides:12, sat:6, glucides:23, proteines:16, kcal:280, portion_g:180, sel:2.2},

  // --- Street-food / fast-food
  {nom:"Burger classique", alias:["burger","hamburger"], lipides:13, sat:5, glucides:25, proteines:15, kcal:270, portion_g:180, sel:1.5},
  {nom:"Kebab sandwich", alias:["kebab"], lipides:12, sat:4, glucides:23, proteines:16, kcal:250, portion_g:250, sel:1.9},
  {nom:"Tacos (viande + fromage)", alias:["tacos"], lipides:16, sat:7, glucides:30, proteines:17, kcal:340, portion_g:250, sel:2.6},
  {nom:"Pizza margherita", alias:["pizza"], lipides:9, sat:4, glucides:28, proteines:10, kcal:240, portion_g:120, sel:1.4},
  {nom:"Frites (four)", alias:["frites"], lipides:8, sat:1.2, glucides:33, proteines:3.4, kcal:230, portion_g:150, sel:0.7},
  {nom:"Wrap poulet crudités", alias:["wrap poulet"], lipides:8, sat:2, glucides:32, proteines:15, kcal:260, portion_g:180, sel:1.9},
  {nom:"Sandwich jambon-beurre", alias:["jambon beurre"], lipides:12, sat:6, glucides:30, proteines:14, kcal:320, portion_g:180, sel:2.7},
  {nom:"Croque-monsieur", alias:["croque monsieur"], lipides:15, sat:7, glucides:27, proteines:16, kcal:320, portion_g:160, sel:2.3},

  // --- Poké / sushis / bowls
  {nom:"Sushi (assortiment)", alias:["sushi","sushis"], lipides:4, sat:1, glucides:28, proteines:11, kcal:190, portion_g:180, sel:1.3},
  {nom:"Poke bowl saumon", alias:["poke saumon","poké saumon"], lipides:10, sat:2.2, glucides:22, proteines:14, kcal:230, portion_g:350, omega3:1.2, sel:1.0},

  // --- Desserts & sucrés
  {nom:"Chocolat noir 70%", alias:["chocolat noir"], lipides:43, sat:25, glucides:46, proteines:8, kcal:598, portion_g:20},
  {nom:"Biscuit sablé", alias:["biscuits sables"], lipides:18, sat:9, glucides:67, proteines:6, kcal:490, portion_g:15, sel:0.8},
  {nom:"Crêpe au sucre", alias:["crepe sucre"], lipides:7, sat:3.5, glucides:35, proteines:6, kcal:260, portion_g:80, sel:0.4},
  {nom:"Tarte aux pommes", alias:["tarte pomme"], lipides:11, sat:5, glucides:35, proteines:3, kcal:260, portion_g:120, sel:0.5},
  {nom:"Compote de pommes (sans sucre ajouté)", alias:["compote"], lipides:0.2, sat:0, glucides:12, proteines:0.2, kcal:50, portion_g:100, sel:0},
  {nom:"Fromage blanc sucré", alias:["fb sucré"], lipides:3, sat:2, glucides:12, proteines:8.5, kcal:110, portion_g:125, sel:0.1},
  {nom:"Yaourt aux fruits", alias:["yaourt fruit"], lipides:2, sat:1.3, glucides:14, proteines:4, kcal:95, portion_g:125, sel:0.1}
];

// ===== Index alias-aware + lookup =====
let INDEX = [];
function rebuildIndex(){
  INDEX = [];
  DB.forEach((x,i)=>{
    INDEX.push({k:norm(x.nom), i});
    (x.alias||[]).forEach(a=> INDEX.push({k:norm(a), i}));
  });
}
rebuildIndex();

function lookup(name){
  const q = norm(name);
  let hit = INDEX.find(o=>o.k===q);
  if(hit) return DB[hit.i];
  hit = INDEX.find(o=>o.k.includes(q));
  if(hit) return DB[hit.i];
  const best = [...new Set(INDEX.map(o=>o.i))]
    .map(i=>{
      const labels=[DB[i].nom,...(DB[i].alias||[])];
      const d=Math.min(...labels.map(lbl=>lev(lbl,name)));
      return {i,d};
    }).sort((a,b)=>a.d-b.d)[0];
  if(best && best.d <= Math.max(2, Math.floor(q.length/4))) return DB[best.i];
  return null;
}

// ===== UI: suggestions (sur le dernier terme saisi) =====
const $ = q=>document.querySelector(q);
const format = n => (Math.round(n*10)/10).toLocaleString('fr-FR');
const num = s => parseFloat(String(s).replace(/\s/g,'').replace(',','.'))||0;

const input = $('#food'); const list = $('#suggestions');
input.addEventListener('input', ()=>{
  const q = norm(input.value.split(',').pop());
  if(!q){ list.hidden=true; return; }
  let hits = INDEX.filter(o=>o.k.includes(q)).slice(0,25).map(o=>DB[o.i]);
  if(hits.length===0) hits = DB.map(x=>({x,d:lev(x.nom,q)})).sort((a,b)=>a.d-b.d).slice(0,8).map(o=>o.x);
  renderSuggest(hits);
});
function renderSuggest(items){
  list.innerHTML=''; if(!items.length){list.hidden=true;return;}
  items.forEach(item=>{
    const row=document.createElement('div'); row.className='suggest-item';
    row.innerHTML = `<span>${item.nom}</span>
      <span class="muted nowrap"><span class="badge">${item.lipides} g lip.</span>
      <span class="badge">${item.kcal} kcal</span>
      ${item.portion_g?`<span class="badge">portion ≈ ${item.portion_g} g</span>`:''}</span>`;
    row.onclick=()=>{
      const parts = input.value.split(',');
      parts[parts.length-1] = ' '+item.nom;
      input.value = parts.join(',').replace(/^,\s*/,'').trim();
      list.hidden=true;
    };
    list.appendChild(row);
  });
  list.hidden=false;
}

// ===== Scoring (1–20) =====
const clamp=(x,a,b)=>Math.min(Math.max(x,a),b);
const scale=(x,a,b,A,B)=> x<=a?A : x>=b?B : A + ((x-a)/(b-a))*(B-A);
function scoreFromMacros(t){
  const per1000 = v => t.kcal ? (v*1000)/t.kcal : 0;
  const sat1000  = per1000(t.sat);
  const carb1000 = per1000(t.glu);
  const dens = t.kcal / (t.g || 1);
  let HDL = 10; if(t.om3>=1.5) HDL+=4; if(t.om3>=2.5) HDL+=2; HDL = clamp(Math.round(HDL),1,20);
  let LDL = 20 - Math.round(scale(sat1000,3,25,0,14)); LDL=clamp(LDL,1,20);
  let GLY = 20 - Math.round(scale(carb1000,80,220,0,14)); GLY=clamp(GLY,1,20);
  let TRI = 20 - Math.round(scale(carb1000,100,220,0,10) + scale(dens,1.5,3.5,0,6)); if(t.om3>=1.5) TRI+=2; TRI=clamp(TRI,1,20);
  let HTA = 20 - Math.round(scale(t.salt||0,0.5,3,0,14)); HTA=clamp(HTA,1,20);
  let FATTY = 20 - Math.round(scale(dens,1.5,3.5,0,10) + scale(sat1000,5,20,0,6)); FATTY=clamp(FATTY,1,20);
  return {HDL,LDL,GLY,TRI,HTA,FATTY};
}
function extras(rec, grams){ const f=grams/100; return {om3:(rec.omega3||0)*f, salt:(rec.sel||0)*f}; }

// ===== Ajouter (multi-termes) =====
const tbody = document.querySelector('#meal tbody');
$('#add').onclick = ()=>{
  const qty = parseFloat($('#qty').value||'0'); const unit = $('#unit').value;
  const raw = input.value.split(',').map(s=>s.trim()).filter(Boolean);
  if(raw.length===0 || !qty) return;

  const unknown=[]; const suggestions=[];
  raw.forEach(name=>{
    let rec = lookup(name);
    if(!rec){
      unknown.push(name);
      const top = DB.map(x=>({x,d:lev(x.nom,name)})).sort((a,b)=>a.d-b.d).slice(0,3).map(o=>o.x.nom);
      suggestions.push(`${name} ⇢ ${top.join(' / ')}`);
      return;
    }
    const grams = unit==='g' ? qty : (rec.portion_g||100)*qty;
    const f = grams/100;
    const macros = {
      g: grams,
      lip: rec.lipides*f, sat: rec.sat*f, glu: (rec.glucides||0)*f, pro: (rec.proteines||0)*f, kcal: (rec.kcal||0)*f,
      ...extras(rec, grams)
    };
    const notes = scoreFromMacros(macros);
    const row=document.createElement('tr');
    row.innerHTML = `
      <td>${rec.nom}</td>
      <td>${format(macros.g)}</td>
      <td>${format(macros.lip)}</td>
      <td>${format(macros.sat)}</td>
      <td>${format(macros.glu)}</td>
      <td>${format(macros.pro)}</td>
      <td>${format(macros.kcal)}</td>
      <td class="score ${notes.HDL>=15?'ok':notes.HDL>=10?'mid':'bad'}">${notes.HDL}</td>
      <td class="score ${notes.LDL>=15?'ok':notes.LDL>=10?'mid':'bad'}">${notes.LDL}</td>
      <td class="score ${notes.GLY>=15?'ok':notes.GLY>=10?'mid':'bad'}">${notes.GLY}</td>
      <td class="score ${notes.TRI>=15?'ok':notes.TRI>=10?'mid':'bad'}">${notes.TRI}</td>
      <td class="score ${notes.HTA>=15?'ok':notes.HTA>=10?'mid':'bad'}">${notes.HTA}</td>
      <td class="score ${notes.FATTY>=15?'ok':notes.FATTY>=10?'mid':'bad'}">${notes.FATTY}</td>
      <td><button class="btn-danger">Supprimer</button></td>`;
    row.querySelector('button').onclick=()=>{row.remove(); computeTotals();};
    tbody.appendChild(row);
  });

  if(unknown.length){
    alert("Introuvables:\n- " + unknown.join('\n- ') + (suggestions.length? "\n\nSuggestions:\n- "+suggestions.join('\n- '):''));
  }
  computeTotals();
  input.value='';
};

// ===== Totaux / ratios =====
function computeTotals(){
  let q=0, lip=0, sat=0, glu=0, pro=0, kcal=0;
  [...tbody.rows].forEach(r=>{
    q+=num(r.cells[1].textContent); lip+=num(r.cells[2].textContent); sat+=num(r.cells[3].textContent);
    glu+=num(r.cells[4].textContent); pro+=num(r.cells[5].textContent); kcal+=num(r.cells[6].textContent);
  });
  $('#t_qte').textContent=format(q);
  $('#t_lip').textContent=format(lip);
  $('#t_sat').textContent=format(sat);
  $('#t_glu').textContent=format(glu);
  $('#t_pro').textContent=format(pro);
  $('#t_kcal').textContent=format(kcal);
  $('#ratio').textContent = kcal ? Math.round((lip*9)/kcal*100) + '%' : '0%';
  $('#satShare').textContent = lip ? Math.round((sat/lip)*100) + '%' : '0%';
}

// ===== Sauvegarde / Chargement / Export =====
$('#save').onclick = ()=>{
  const rows = [...tbody.rows].map(r=>({nom:r.cells[0].textContent, grams:num(r.cells[1].textContent)}));
  localStorage.setItem('lipidecoach_meal', JSON.stringify(rows));
};
$('#load').onclick = ()=>{
  const raw = localStorage.getItem('lipidecoach_meal'); if(!raw) return;
  tbody.innerHTML=''; JSON.parse(raw).forEach(({nom,grams})=>{
    const rec = DB.find(x=>x.nom===nom); if(!rec) return;
    const f=grams/100;
    const macros={g:grams,lip:rec.lipides*f,sat:rec.sat*f,glu:(rec.glucides||0)*f,pro:(rec.proteines||0)*f,kcal:(rec.kcal||0)*f,...extras(rec,grams)};
    const notes=scoreFromMacros(macros);
    const row=document.createElement('tr');
    row.innerHTML=`
      <td>${rec.nom}</td>
      <td>${format(macros.g)}</td>
      <td>${format(macros.lip)}</td>
      <td>${format(macros.sat)}</td>
      <td>${format(macros.glu)}</td>
      <td>${format(macros.pro)}</td>
      <td>${format(macros.kcal)}</td>
      <td class="score ${notes.HDL>=15?'ok':notes.HDL>=10?'mid':'bad'}">${notes.HDL}</td>
      <td class="score ${notes.LDL>=15?'ok':notes.LDL>=10?'mid':'bad'}">${notes.LDL}</td>
      <td class="score ${notes.GLY>=15?'ok':notes.GLY>=10?'mid':'bad'}">${notes.GLY}</td>
      <td class="score ${notes.TRI>=15?'ok':notes.TRI>=10?'mid':'bad'}">${notes.TRI}</td>
      <td class="score ${notes.HTA>=15?'ok':notes.HTA>=10?'mid':'bad'}">${notes.HTA}</td>
      <td class="score ${notes.FATTY>=15?'ok':notes.FATTY>=10?'mid':'bad'}">${notes.FATTY}</td>
      <td><button class="btn-danger">Supprimer</button></td>`;
    row.querySelector('button').onclick=()=>{row.remove(); computeTotals();};
    tbody.appendChild(row);
  });
  computeTotals();
};
$('#clear').onclick = ()=>{ tbody.innerHTML=''; computeTotals(); };
$('#export-csv').onclick = ()=>{
  const head='aliment,grammes,lipides,satures,glucides,proteines,kcal,hdl,ldl,gly,tri,hta,steatose';
  const lines=[...tbody.rows].map(r=>[
    r.cells[0].textContent, ...[1,2,3,4,5,6,7,8,9,10,11,12].map(i=>r.cells[i].textContent.replace(/\s/g,''))]
    .join(','));
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([[head,...lines].join('\n')],{type:'text/plain'}));
  a.download='repas.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500);
};
</script>
</body>
</html>
